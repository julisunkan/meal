{% extends "base.html" %}

{% block title %}{% if is_sample %}Sample {% endif %}Your Meal Plan{% endblock %}

{% block header_title %}{% if is_sample %}Sample {% endif %}Your Meal Plan{% endblock %}
{% block header_subtitle %}{% if is_sample %}{{ metadata.culture }} Cultural Journey - {% endif %}Delicious meals planned just for you{% endblock %}

{% block content %}
<div class="d-flex gap-2 mb-3 flex-wrap">
    <a href="{{ url_for('export_pdf') }}" class="btn btn-danger flex-fill">
        <i class="fas fa-file-pdf me-1"></i>PDF
    </a>
    <a href="{{ url_for('export_json') }}" class="btn btn-success flex-fill">
        <i class="fas fa-download me-1"></i>JSON
    </a>
    <a href="{{ url_for('index') }}" class="btn btn-primary flex-fill">
        <i class="fas fa-plus me-1"></i>New
    </a>
</div>

{% if metadata %}
<div class="card mb-3">
    <div class="card-body">
        <h6 class="gradient-text mb-3"><i class="fas fa-circle-info me-2"></i>Plan Details</h6>
        <div class="d-flex flex-wrap gap-2 mb-2">
            <span class="badge" style="background: var(--primary-gradient);">
                <i class="fas fa-calendar me-1"></i>{{ metadata.days }} days
            </span>
            {% if metadata.race %}
            <span class="badge" style="background: var(--secondary-gradient);">
                <i class="fas fa-earth-americas me-1"></i>{{ metadata.race }}
            </span>
            {% endif %}
            {% for pref in metadata.dietary_prefs %}
            <span class="badge" style="background: var(--success-gradient);">
                <i class="fas fa-leaf me-1"></i>{{ pref }}
            </span>
            {% endfor %}
        </div>
        {% if metadata.ingredients %}
        <p class="text-muted small mb-0">
            <i class="fas fa-refrigerator me-1"></i>{{ metadata.ingredients | join(', ') }}
        </p>
        {% endif %}
    </div>
</div>
{% endif %}

{% for day, meals in meal_plan.items() %}
<div class="card mb-3">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-calendar-day me-2"></i>{{ day }}</h5>
    </div>
    <div class="card-body p-2">
        <div class="row g-2">
            {% for meal_type, recipe in meals.items() %}
            {% if recipe %}
            <div class="col-6">
                <a href="{{ url_for('recipe_detail', recipe_id=recipe.id) }}" class="recipe-link">
                    <div class="meal-card">
                        <div class="d-flex align-items-center mb-2">
                            <div style="background: {% if meal_type == 'breakfast' %}var(--warning-gradient){% elif meal_type == 'lunch' %}var(--success-gradient){% elif meal_type == 'dinner' %}var(--primary-gradient){% elif meal_type == 'dessert' %}var(--secondary-gradient){% elif meal_type == 'drink' %}var(--info-gradient){% else %}var(--primary-gradient){% endif %}; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 0.75rem;">
                                <i class="fas fa-{{ 'mug-saucer' if meal_type == 'breakfast' else 'bowl-food' if meal_type == 'lunch' else 'plate-wheat' if meal_type == 'dinner' else 'ice-cream' if meal_type == 'dessert' else 'martini-glass' if meal_type == 'drink' else 'cookie' }} fa-lg" style="color: white;"></i>
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div class="text-uppercase fw-bold" style="font-size: 0.7rem; color: #94A3B8;">{{ meal_type }}</div>
                                <div class="fw-bold" style="font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ recipe.title }}</div>
                            </div>
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <span class="nutrition-badge" style="font-size: 0.7rem;">
                                <i class="fas fa-fire me-1"></i>{{ recipe.calories }}
                            </span>
                            <span class="nutrition-badge" style="font-size: 0.7rem;">
                                <i class="fas fa-dumbbell me-1"></i>{{ recipe.protein }}g
                            </span>
                        </div>
                    </div>
                </a>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
</div>
{% endfor %}

{% if shopping_list %}
<div class="card mb-3">
    <div class="card-header" style="background: var(--success-gradient);">
        <h5 class="mb-0" style="color: white;">
            <i class="fas fa-cart-shopping me-2"></i>Shopping List
        </h5>
    </div>
    <div class="card-body">
        {% for category, ingredients in shopping_list.items() %}
        {% if ingredients %}
        <div class="shopping-category">
            <h6 class="gradient-text mb-2">
                <i class="fas fa-{{ 'drumstick-bite' if category == 'protein' else 'carrot' if category == 'vegetable' else 'bread-slice' if category == 'grain' else 'cheese' if category == 'dairy' else 'pepper-hot' if category == 'spice' else 'apple-whole' if category == 'fruit' else 'seedling' }} me-1"></i>
                {{ category.title() }}
            </h6>
            {% for ingredient in ingredients %}
            <div class="ingredient-item">
                <i class="fas fa-circle-check me-2" style="color: #6C63FF;"></i>{{ ingredient }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="card mb-3">
    <div class="card-header" style="background: var(--info-gradient);">
        <h5 class="mb-0" style="color: white;">
            <i class="fas fa-chart-pie me-2"></i>Daily Nutrition
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-sm mb-0">
                <thead>
                    <tr>
                        <th style="padding: 0.75rem;">Day</th>
                        <th style="padding: 0.75rem;">Cal</th>
                        <th style="padding: 0.75rem;">Protein</th>
                        <th style="padding: 0.75rem;">Carbs</th>
                        <th style="padding: 0.75rem;">Fat</th>
                    </tr>
                </thead>
                <tbody>
                    {% for day, meals in meal_plan.items() %}
                    <tr>
                        <td style="padding: 0.75rem;"><strong>{{ day }}</strong></td>
                        <td style="padding: 0.75rem;">
                            {% set total_calories = meals.values() | selectattr('calories') | map(attribute='calories') | sum %}
                            {{ total_calories }}
                        </td>
                        <td style="padding: 0.75rem;">
                            {% set total_protein = meals.values() | selectattr('protein') | map(attribute='protein') | sum %}
                            {{ "%.0f" | format(total_protein) }}g
                        </td>
                        <td style="padding: 0.75rem;">
                            {% set total_carbs = meals.values() | selectattr('carbs') | map(attribute='carbs') | sum %}
                            {{ "%.0f" | format(total_carbs) }}g
                        </td>
                        <td style="padding: 0.75rem;">
                            {% set total_fat = meals.values() | selectattr('fat') | map(attribute='fat') | sum %}
                            {{ "%.0f" | format(total_fat) }}g
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}